<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <title>Resultados electorales Legislativas 2013 — LaNacion.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
        <![endif]-->
    <style type="text/css" media="screen">
      html, body {
        margin: 0; padding: 0; height: 100%;
      }

      #credits {
        width: 300px;
        height: 270px;
        position:absolute;
        top:50%;
        bottom:0;
        left:0;
        right:0;
        margin: auto;
        margin-top: -135px;
        padding: 4px 4px;
        background-color:rgba(255,255,255,1);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
        font-size: 12px;
        font-family: Helvetica, Arial, sans-serif;
        visibility: hidden;
      }
      #credits button { background-color: #ddd; border: 1px solid #ccc; cursor: pointer;}
      #overlay, #filtro {
        position:absolute;
        width: 25%;
        min-height: 160px;
        top: 22px;
        left: 100%;
        padding: 4px 4px;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 12px;
        line-height: 100%;
        color: #223;
        background-color:rgba(255,255,255,1);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 4px;
        transition: all 0.5s;
        -webkit-transition: all 0.5s;
        -moz-transition: all 0.5s;
      }

      #filtro {
        left: 43px;
        top: 10px;
        min-height: 20px;
        width: 150px;
        overflow: auto;
        overflow-x: hidden;
        max-height: 95%;
        padding: 4px;
      }
      #secciones-container {
        position: relative;
        margin: 0px; width: 300px;
        -webkit-transition: all 0.5s;
        -moz-transition: all 0.5s;
        transition: all 0.5s;
      }
      #secciones-menu { float: left; width: 150px;}
      #secciones-escuelas { float: left; width: 150px ; }
      #secciones-escuelas button {
        border: 0; background-color: white; outline: none;
        padding: 0;
        cursor: pointer;
      }
      #filtro h1 span {
        width: 10px; text-align: center; display: inline-block;
      }

      #filtro ul {
        margin-top: 0;
        list-style-type: none;
        padding-left: 0;
      }

      #secciones-escuelas ul {
        list-style-type: disc;
        padding-left: 13px;
      }

      #secciones-escuelas ul li {
        margin-bottom: 5px;
      }

      #filtro h1:hover {
        cursor: pointer;
      }

      #filtro a {
        color: black; text-decoration: none;
      }

      #filtro a:hover {
        text-decoration: underline;
      }

      #overlay .chart {
        display: block !important;
      }

      #filtro h1, #filtro h2, #overlay h1, #overlay h2 {
        font-size: 1em;
        margin: 5px 0px 5px 0px;
        line-height: 100%;
      }
      #overlay h1 {
        font-size: 1.2em;
      }
      #overlay h2,  {
        font-weight: bold;
        margin: 0px 0px 0px 0px;
        color: #999;
      }
      #overlay h3 {
        margin: 0px;
      }
      #overlay ul {
        margin-left: 0;
        list-style-type: none;
        padding-left: 0;
      }
      #overlay ul li {
        float: left;
        width: 30px;
      }
      #overlay li a {
        text-decoration: none;
        color: blue;
      }
      #overlay li a.chosen {

      }
      .leaflet-popup * {
        line-height: 100%;
      }
      .leaflet-popup h1 { font-size: 14px; margin: 3px 0 3px 0; }
      .leaflet-popup h2 { color: #999; margin-top: 2px; margin-bottom: 2px; font-size: 1em;}
      .leaflet-popup p { margin: 5px 0; }
      .spinner {
        left: 50% !important;
        margin-top: -20% !important;
      }
    </style>
  </head>
  <body>
    <div id="map" style="height: 100%; min-height: 600px;">
    </div>
    <!--Aqui meteremos las comunas -->
    <div id="filtro">
    </div>
    <!--Aquí va la parte de resultados de un determinado establecimiento -->
    <div id="overlay" style="left: 100%;">
    </div>
    <!-- Créditos de la app -->
    <div id="credits">
      <p>Elaborado con datos de <a target="_blank" href="http://www.resultados.gob.ar">Dirección Nacional Electoral</a>, <a target="_blank" href="http://www.mapaeducativo.edu.ar">Ministerio de Educación</a> y procesamiento propio</p>
      <p>Resultados a nivel mesa agregados por establecimiento para precandidatos a intendente (PASO 2015)</p>
      <p><strong>Producción de datos</strong>: Inés Pujana, Florencia Coelho, Guadalupe López</p>
      <p><strong>Programación y procesamiento de datos</strong>: <a href="http://juanelosua.com" target="_blank">Juan Elosua</a> (<a target="_blank" href="http://www.opennews.org/">Knight-Mozilla OpenNews</a>)</p>
      <p><strong>Jefe de diseño interactivo</strong>: Juan Diego López</p>
      <p><strong>Editor responsable</strong>: Gastón Roitberg</p>
      <p style="width: 100%; text-align: right"><button>cerrar</button></p>
    </div>

    <script type="text/template" id="popup-template">
      <h1><%- establecimiento.establecim %></h1>
      <% var prov = _.find(DISTRITOS, function(d) { return d.distrito_id == establecimiento.dne_distri; });
         var secc = _.find(prov.secciones, function(s) { return s.departamento == establecimiento.dne_seccio; }); %>
      <h2><%-  secc.nombre %> — <%- secc.provincia == 1 ? 'Capital Federal' : 'Buenos Aires' %></h2>
      <p>Participación: <strong><%- ((establecimiento.votantes / establecimiento.electores) * 100).toFixed(2) %>%</strong></p>
      <!-- p>Comuna: <strong><%- establecimiento.dne_seccio %></strong> — Circuito: <strong><%- establecimiento.circuito %></strong></p -->
      <p>Mesas de <strong><%- establecimiento.mesa_desde %></strong> a <strong><%- establecimiento.mesa_hasta %></strong></p>
    </script>

    <!--JET: Listado de secciones - Navegación-->
    <script type="text/template" id="secciones-template">
      <div id="secciones-container">
        <div id="secciones-menu">
          <% _.each(distritos, function(d) { %>
          <h1><span>▸</span> <%- d.provincia %></h1>
          <ul style="display: none;">
            <% _.each(_.sortBy(d.secciones, function(s) { return s.departamento; }), function(s) { %>
            <li><a href="<%- s.provincia %>/<%- s.departamento %>" data-bounds="<%- JSON.stringify(s.bounds) %>" data-dne_distri="<%- s.provincia %>" data-dne_seccio="<%- s.departamento %>"><%- s.nombre %></a></li>
            <% }); %>
          </ul>
          <% }); %>
        </div>
        <div id="secciones-escuelas">
        </div>
      </div>
    </script>

    <script type="text/template" id="secciones-escuelas-template">
      <button>← Volver</button>
      <h1><%- seccion %></h1>
      <ul>
      <% _.each(escuelas, function(e) { %>
      <li><a href="" data-establecimiento='<%- btoa(JSON.stringify(e)) %>' data-point="<%- JSON.parse(e.g)['coordinates'] %>"><%- e.establecim %></a></li>
      <% }); %>
      </ul>
    </script>

    <script type="text/template" id="overlay-template">
      <h1><%- establecimiento.establecim %></h1>
      <h2><%- establecimiento.direccion %></h2>
      <div class="chart" style="height: 160px; width: 100%;"></div>
      <h3>Telegramas de mesas</h3>
      <ul>
        <% for (var i=parseInt(establecimiento.mesa_desde); i <= parseInt(establecimiento.mesa_hasta); i++) { %>
           <li><a target="_blank" href="http://www.resultados.gob.ar/telegramas/<%- pad(establecimiento.dne_distri, 2) %>/<%- pad(establecimiento.dne_seccio, 3) %>/<%- establecimiento.circuito.match(/[A-Z]/) ? establecimiento.circuito : pad(parseInt(establecimiento.circuito),4) %>/<%- pad(establecimiento.dne_distri, 2) + pad(establecimiento.dne_seccio, 3) + (establecimiento.circuito.match(/[A-Z]/) ? establecimiento.circuito : pad(parseInt(establecimiento.circuito),4)) %><%- establecimiento.circuito.match(/[A-Z]/) ? '' : '_' %><%- pad(i, 4) %>.htm"><%- i %></a></li>
           <% } %>
      </ul>
    </script>
    <script type="text/javascript" src="js/spin.min.js"></script>
    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

    <script type="text/javascript">
      function pad(num, size) {
          var s = num+"";
          while (s.length < size) s = "0" + s;
          return s;
      }

      var DISTRITOS = [{"secciones": [{"nombre": "Comuna 2", "provincia": 1, "bounds": [[-58.4160004849245, -34.5997603196348], [-58.4160004849245, -34.5693489037078], [-58.3706956893502, -34.5693489037078], [-58.3706956893502, -34.5997603196348], [-58.4160004849245, -34.5997603196348]], "departamento": 2}, {"nombre": "Comuna 5", "provincia": 1, "bounds": [[-58.4333340897605, -34.6402003756307], [-58.4333340897605, -34.5977128043017], [-58.4104885535212, -34.5977128043017], [-58.4104885535212, -34.6402003756307], [-58.4333340897605, -34.6402003756307]], "departamento": 5}, {"nombre": "Comuna 6", "provincia": 1, "bounds": [[-58.4627046323134, -34.6306390990819], [-58.4627046323134, -34.6026734568799], [-58.4267558142259, -34.6026734568799], [-58.4267558142259, -34.6306390990819], [-58.4627046323134, -34.6306390990819]], "departamento": 6}, {"nombre": "Comuna 7", "provincia": 1, "bounds": [[-58.4778072341569, -34.6568064568917], [-58.4778072341569, -34.6138856719602], [-58.4234918835546, -34.6138856719602], [-58.4234918835546, -34.6568064568917], [-58.4778072341569, -34.6568064568917]], "departamento": 7}, {"nombre": "Comuna 9", "provincia": 1, "bounds": [[-58.5303590477146, -34.6745085923533], [-58.5303590477146, -34.6327972323397], [-58.4604018719539, -34.6327972323397], [-58.4604018719539, -34.6745085923533], [-58.5303590477146, -34.6745085923533]], "departamento": 9}, {"nombre": "Comuna 10", "provincia": 1, "bounds": [[-58.531518740591, -34.6458181705157], [-58.531518740591, -34.6091257666556], [-58.471302914919, -34.6091257666556], [-58.471302914919, -34.6458181705157], [-58.531518740591, -34.6458181705157]], "departamento": 10}, {"nombre": "Comuna 11", "provincia": 1, "bounds": [[-58.5294689967804, -34.6246298692564], [-58.5294689967804, -34.5812681200754], [-58.4584739254559, -34.5812681200754], [-58.4584739254559, -34.6246298692564], [-58.5294689967804, -34.6246298692564]], "departamento": 11}, {"nombre": "Comuna 12", "provincia": 1, "bounds": [[-58.5155362814466, -34.5939535746883], [-58.5155362814466, -34.5386305921147], [-58.4664901777516, -34.5386305921147], [-58.4664901777516, -34.5939535746883], [-58.5155362814466, -34.5939535746883]], "departamento": 12}, {"nombre": "Comuna 14", "provincia": 1, "bounds": [[-58.4490443843996, -34.5978547718644], [-58.4490443843996, -34.5509360411806], [-58.3927899180477, -34.5509360411806], [-58.3927899180477, -34.5978547718644], [-58.4490443843996, -34.5978547718644]], "departamento": 14}, {"nombre": "Comuna 3", "provincia": 1, "bounds": [[-58.4146599808851, -34.6303558693605], [-58.4146599808851, -34.5980030767748], [-58.3911698015239, -34.5980030767748], [-58.3911698015239, -34.6303558693605], [-58.4146599808851, -34.6303558693605]], "departamento": 3}, {"nombre": "Comuna 15", "provincia": 1, "bounds": [[-58.503543766591, -34.6076156442747], [-58.503543766591, -34.5724961753266], [-58.4233672222353, -34.5724961753266], [-58.4233672222353, -34.6076156442747], [-58.503543766591, -34.6076156442747]], "departamento": 15}, {"nombre": "Comuna 8", "provincia": 1, "bounds": [[-58.5025259133722, -34.7052931351596], [-58.5025259133722, -34.6508230773584], [-58.4240353261196, -34.6508230773584], [-58.4240353261196, -34.7052931351596], [-58.5025259133722, -34.7052931351596]], "departamento": 8}, {"nombre": "Comuna 4", "provincia": 1, "bounds": [[-58.4349230922177, -34.6625039295949], [-58.4349230922177, -34.6176387636499], [-58.3351430067124, -34.6176387636499], [-58.3351430067124, -34.6625039295949], [-58.4349230922177, -34.6625039295949]], "departamento": 4}, {"nombre": "Comuna 1", "provincia": 1, "bounds": [[-58.3929308254775, -34.6341243913884], [-58.3929308254775, -34.5736496820514], [-58.3398445010592, -34.5736496820514], [-58.3398445010592, -34.6341243913884], [-58.3929308254775, -34.6341243913884]], "departamento": 1}, {"nombre": "Comuna 13", "provincia": 1, "bounds": [[-58.4759530989691, -34.5831708409276], [-58.4759530989691, -34.5275410741022], [-58.4256740143058, -34.5275410741022], [-58.4256740143058, -34.5831708409276], [-58.4759530989691, -34.5831708409276]], "departamento": 13}], "provincia": "Capital Federal", "distrito_id": 1}];



      $(function() {


          var SPINNER_OPTS = {
              lines: 13, // The number of lines to draw
              length: 10, // The length of each line
              width: 3, // The line thickness
              radius: 10, // The radius of the inner circle
              corners: 1, // Corner roundness (0..1)
              rotate: 0, // The rotation offset
              direction: 1, // 1: clockwise, -1: counterclockwise
              color: '#000', // #rgb or #rrggbb
              speed: 1.1, // Rounds per second
              trail: 60, // Afterglow percentage
              shadow: false, // Whether to render a shadow
              hwaccel: true, // Whether to use hardware acceleration
              className: 'spinner', // The CSS class to assign to the spinner
              zIndex: 2e9, // The z-index (defaults to 2000000000)
              top: 'auto', // Top position relative to parent in px
              left: 'auto' // Left position relative to parent in px
          };
          var PARTIDOS_COLORES = {
              503:'#ffeb7d', // PRO
              505:'red', // FIT
              510:'#2c4c9e', // MASSA
              507:'#ed4646', // DE NARVAEZ
              514:'#9b32cc', // FPCyS
              501:'#4acdff', // FPV
              502:'#5dbc64', // UNEN
              513:'#f5a718', // VENEGAS
              008:'#2ca02c',
              325:'#d62728',
              234:'#9467bd',
              068:'#8c564b',
              324:'#e377c2',
              262:'#1f77b4',
              506:'#ff7f0e',
              504:'#2ca02c',
              187:'#8c564b',
              131:'#e377c2',
              137:'#1f77b4',
              9999: '#aaaaaa'
          };
          
          var carto_layers = { '2015_caba_paso': null}

          map = L.map('map', {
              center: [-34.61597432902992, -58.442115783691406],
              zoom: 9,
              minZoom: 9,
              maxZoom: 16,
              attributionControl: false
          });
          var mapboxUrl = 'http://otile1.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png';
          var mapbox = L.tileLayer(mapboxUrl, {attribution: "OpenStreetMaps"}).addTo(map);
          var _a = new L.Control.Attribution( { position: 'topright', prefix: false} );
          _a.addAttribution('LaNacion.com — <a href="#" onclick="$(\'#credits\').css(\'visibility\', \'visible\'); return false;" id="showcredits"><strong>Creditos</strong></a>');
          _a.removeAttribution("CartoDB <a href='http://cartodb.com/attributions' target='_blank'>attribution</a>");
          _a.addTo(map);
          (new L.Control.Attribution({position: 'bottomright', prefix: false})).addAttribution('Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png">').addTo(map);

          //JET: template for the description of a given polling station
          var popup_tmpl = _.template($('#popup-template').html());
          //JET: template for the results of a given polling station
          var overlay_tmpl = _.template($('#overlay-template').html());
          var current_ltlng = null;
          var featureClicked = false;
          var prevScrollTop = 0;
          var prevSeccion = null;

          var CARTODB_USER = 'lndata';

          sql = new cartodb.SQL({
              user: CARTODB_USER
          });

          var SECCIONES_ESCUELAS_TMPL = _.template($('#secciones-escuelas-template').html());
          var LAYER_SQL_TMPL = _.template("SELECT * FROM cache_votos_diputados_octubre");
          var ESTABLECIMIENTOS_SQL_TMPL = "SELECT *, st_asgeojson(the_geom) as g FROM cache_votos_diputados_octubre WHERE dne_distri = {{dne_distri}} AND dne_seccio = {{dne_seccio}} ORDER BY circuito, establecim";

          $('#filtro').html(_.template($('#secciones-template').html())({distritos: DISTRITOS }));

          $('#filtro h1').on('click', function(e) {
              var ul = $(this).next('ul');
              var span = $('span', $(this));
              if (ul.css('display') == 'block') {
                  span.html('▸'); ul.css('display', 'none');
              }
              else {
                  span.html('▾'); ul.css('display', 'block');
              }
          });

          $('#filtro a').on('click', function(e) {
              e.preventDefault();
              if (prevSeccion !== $(this)) hideOverlay();
              prevSeccion = $(this);
              var seccion_nombre = $(this).html();
              var t = $(this).data('bounds');
              var b = new L.LatLngBounds(new L.LatLng(t[0][1], t[0][0]),
                                         new L.LatLng(t[1][1], t[1][0]));
              var z = map.fitBounds(b);
              new Spinner(SPINNER_OPTS).spin($('#secciones-escuelas').get(0))
              prevScrollTop = $('#filtro').scrollTop();
              $('#filtro').scrollTop(0);
              $('#secciones-container').css('left', '-150px');
              sql.execute(ESTABLECIMIENTOS_SQL_TMPL,
                          {
                              dne_seccio: $(this).data('dne_seccio'),
                              dne_distri: $(this).data('dne_distri')
                          })
                  .done(function(data) {
                      var h = SECCIONES_ESCUELAS_TMPL({
                          seccion: seccion_nombre,
                          escuelas: data.rows
                      });
                      $('#secciones-escuelas').html(h);
                  });
          });

          $(document).on({
              click: function(e) {
                  e.preventDefault();
                  var point = _.map($(this).data('point').split(','), parseFloat);
                  var latlng = L.latLng(point[1], point[0]);
                  var d = JSON.parse(atob($(this).data('establecimiento')));
                  featureClick(e, latlng, map.latLngToLayerPoint(latlng), d, 0);
                  map.setView(latlng, 14);
              }
          }, '#secciones-escuelas a');

          $(document).on({
              click: function(e) {
                  $('#secciones-container').css('left', '5px');
                  $('#filtro').scrollTop(prevScrollTop);
              }
          }, '#secciones-escuelas button');





          var CARTOCSS_TMPL = _.template(' \
      #locales_de_votaci_n_paso_2013_caba { \n \
      marker-opacity: 0.7; \n \
      marker-allow-overlap: true; \n \
      marker-line-width: 0; \n \
      marker-line-opacity: 1; \n \
      [zoom = 6] { \n \
        marker-width: 5 + ([margin_of_victory] / [sqrt_positivos]) * 1; \n \
        <% _.each(_.pairs(colores), function(p) { %> \n \
        [vot_parcodigo=<%- p[0] %>] { \n \
          marker-fill: <%- p[1] %>; \n \
          marker-line-color: <%- p[1] %>; \n \
        } \n \
        <% }); %> \n \
      } \n \
      [zoom = 7] { \n \
      marker-width: 5 + ([margin_of_victory] / [sqrt_positivos]) * 2; \n \
      <% _.each(_.pairs(colores), function(p) { %> \n \
        [vot_parcodigo=<%- p[0] %>] { \n \
        marker-fill: <%- p[1] %>; \n \
        marker-line-color: <%- p[1] %>; \n \
        } \n \
        <% }); %> \n \
      } \n \
      [zoom = 8] { \n \
      marker-width: 5 + ([margin_of_victory] / [sqrt_positivos]) * 4; \n \
      <% _.each(_.pairs(colores), function(p) { %> \n \
      [vot_parcodigo=<%- p[0] %>] { \n \
      marker-fill: <%- p[1] %>; \n \
      marker-line-color: <%- p[1] %>; \n \
      } \n \
      <% }); %> \n \
      } \n \
      [zoom = 9] { \n \
      marker-width: 5 + ([margin_of_victory] / [sqrt_positivos]) * 8; \n \
      <% _.each(_.pairs(colores), function(p) { %> \n \
      [vot_parcodigo=<%- p[0] %>] { \n \
      marker-fill: <%- p[1] %>; \n \
      marker-line-color: <%- p[1] %>; \n \
      } \n \
      <% }); %> \n \
      } \n \
      [zoom = 10] { \n \
      marker-width: 5 + ([margin_of_victory] / [sqrt_positivos]) * 16; \n \
      <% _.each(_.pairs(colores), function(p) { %> \n \
      [vot_parcodigo=<%- p[0] %>] { \n \
      marker-fill: <%- p[1] %>; \n \
      marker-line-color: <%- p[1] %>; \n \
      } \n \
      <% }); %> \n \
      } \n \
      [zoom = 11] { \n \
      marker-width: 5 + ([margin_of_victory] / [sqrt_positivos]) * 32; \n \
      <% _.each(_.pairs(colores), function(p) { %> \n \
      [vot_parcodigo=<%- p[0] %>] { \n \
      marker-fill: <%- p[1] %>; \n \
      marker-line-color: <%- p[1] %>; \n \
      } \n \
      <% }); %> \n \
      } \n \
      [zoom = 12] { \n \
      marker-width: 5 + ([margin_of_victory] / [sqrt_positivos]) * 64; \n \
      <% _.each(_.pairs(colores), function(p) { %> \n \
      [vot_parcodigo=<%- p[0] %>] { \n \
      marker-fill: <%- p[1] %>; \n \
      marker-line-color: <%- p[1] %>; \n \
      } \n \
      <% }); %> \n \
      } \n \
      [zoom = 13] { \n \
      marker-width: 5 + ([margin_of_victory] / [sqrt_positivos]) * 100; \n \
      <% _.each(_.pairs(colores), function(p) { %> \n \
      [vot_parcodigo=<%- p[0] %>] { \n \
      marker-fill: <%- p[1] %>; \n \
      marker-line-color: <%- p[1] %>; \n \
      } \n \
      <% }); %> \n \
      } \n \
      [zoom >= 14] { \n \
      marker-width: 5 + ([margin_of_victory] / [sqrt_positivos]) * 128; \n \
      <% _.each(_.pairs(colores), function(p) { %> \n \
      [vot_parcodigo=<%- p[0] %>] { \n \
      marker-fill: <%- p[1] %>; \n \
      marker-line-color: <%- p[1] %>; \n \
      } \n \
      <% }); %> \n \
      } \n \
      }');

          var FEATURE_CLICK_TMPL = _.template("SELECT p.pardenominacion, v.vot_parcodigo, SUM(votvotospartido) \
      FROM votos v \
      LEFT OUTER JOIN partidos_octubre p ON p.parcodigo = v.vot_parcodigo \
      WHERE vot_mescodigomesa >= {{mesa_desde}} \
      AND vot_mescodigomesa <= {{mesa_hasta}} \
      AND vot_depcodigodepartamento = <%- establecimiento.dne_seccio %> \
      AND vot_procodigoprovincia = <%- establecimiento.dne_distri %> \
      AND votacion = '<%- votacion %>' \
      GROUP BY vot_parcodigo, p.pardenominacion \
      ORDER BY SUM(votvotospartido) DESC");

          // Cerrar los creditos
          $('#credits button').on('click', function(e) {
              e.preventDefault();
              $('#credits').css('visibility', 'hidden');
              return false;
          });

          //JET: hide overlay by shifting to the left
          var hideOverlay = function() {
              $('#overlay').css('left', '100%');
          };
          //JET: show overlay by shifting to the left
          var showOverlay = function() {
              $('#overlay').css('left', '73%');
          };

          //JET: If we move the map manually and the overlay falls out of bounds hide overlay
          map.on('dragend', function(e, x, y) {
              if (current_ltlng !== null && !map.getBounds().contains(current_ltlng)) {
                  hideOverlay();
              }
          });

          //JET
          map.on('popupclose', function() {
              if (featureClicked) featureClicked = false;
          });

          //JET: if we are over a polling station change cursor to pointer
          var featureOver = function(e, latlng, pos, data, layerNumber) {
              $('#map').css('cursor', 'pointer');
          };

          //JET: reset when we are not over a polling station
          var featureOut = function(e, layer) {
              $('#map').css('cursor', 'auto');
          };

          var barChart = function(data) {
              var h = 300;
              var svg = d3.select("#overlay .chart")
                  .append("svg")
                  .attr('viewBox', '0 0 100 160')
                  .attr("preserveAspectRatio", "xMinYMin meet")
                  .attr("width", '100%')
                  .attr("height", '100%');


              var scale = d3.scale.linear()
                  .domain([0, _.max(_.map(data,
                                          function(d) { return d.sum; }))])
                  .range([0, 100]);

              svg.selectAll("rect")
                  .data(data)
                  .enter()
                  .append("rect")
                  .attr("x", 0)
                  .attr("y", function(d, i) {
                      return i * 27 + 18;
                  })
                  .attr("height", 10)
                  .attr("fill", function(d) {
                      return PARTIDOS_COLORES[parseInt(d.vot_parcodigo)];
                  })
                  .attr("width", function(d) { return scale(d.sum); });

              svg.selectAll("text")
                  .data(data)
                  .enter()
                  .append('text')
                  .attr('x', function(d) { return scale(d.sum) + 5; } )
                  .attr('y', function(d,i) { return i * 27 + 27; })
                  .attr('font-size', '10px')
                  .attr('fill', '#555')
                  .attr('font-family', 'Helvetica, Arial, sans-serif')
                  .text(function(d) { return d.pct.toFixed(2) + '% - ' + d.sum + ' votos'; });

              svg.append('g').selectAll("text")
                  .data(data)
                  .enter()
                  .append('text')
                  .attr('x', 0)
                  .attr('y', function(d,i) { return i * 27 + 15; })
                  .attr('font-size', '10px')
                  .attr('fill', 'black')
                  .attr('font-family', 'Helvetica, Arial, sans-serif')
                  .text(function(d) { return d.pardenominacion; });
          };

          //JET: TODO
          var featureClickDone = function(latlng, establecimiento_data, votos_data) {
              var popup = L.popup()
                  .setLatLng(latlng)
                  .setContent(popup_tmpl({establecimiento: establecimiento_data}))
                  .openOn(map);

              var d = votos_data.rows.slice(0,4);
              d.forEach(function(d) {
                  d.pct = (d.sum / establecimiento_data.positivos) * 100;
              });
              var sum_otros = _.reduce(votos_data.rows.slice(4), function(m, s) { return m + s.sum; }, 0);
              d[4] = {
                  pardenominacion: 'Otros',
                  sum: sum_otros,
                  vot_parcodigo: 9999,
                  pct: (sum_otros / establecimiento_data.positivos) * 100
              };

              $('#overlay').html(overlay_tmpl({
                  establecimiento: establecimiento_data,
                  escrutinio: d
              }));
              $('#overlay *').fadeIn(200);
              barChart(d);
          };

          //JET: 
          var featureClick = function(event, latlng, pos, establecimiento_data, layerIndex) {
              $('#overlay *').fadeOut(200, function() { $(this).remove(); });
              setTimeout(function() { new Spinner(SPINNER_OPTS).spin($('#overlay').get(0)) }, 200);
              showOverlay();
              current_ltlng = latlng;
              //map.panTo(latlng);
              setTimeout(function() {
                  var query = FEATURE_CLICK_TMPL({
                      votacion: 'VotosCandidaturaMesasDNacionales',
                      establecimiento: establecimiento_data
                  });
                  sql.execute(query, establecimiento_data)
                      .done(_.partial(featureClickDone, latlng, establecimiento_data))
                      .error(function(errors) {
                          // errors contains a list of errors
                      });
              }, 200);
          };
          cartodb.createLayer(map, {
               user_name: CARTODB_USER,
               type: 'cartodb',
               sublayers: [{
                   sql: LAYER_SQL_TMPL({votacion: 'VotosCandidaturaMesasDNacionales'}),
                   cartocss: CARTOCSS_TMPL({ colores: PARTIDOS_COLORES }),
                   interactivity: 'establecim,direccion,dne_distri,dne_seccio,circuito,mesa_desde,mesa_hasta, electores, votantes, positivos,total_parcodigo,vot_parcodigo,margin_of_victory, sqrt_positivos',
               }]
           })
              .addTo(map)
              .on('done', function(layer) {
                  carto_layers['2015_caba_paso'] = layer;
                  layer.setInteraction(true);
                  layer.on('featureOver', featureOver)
                      .on('featureOut', featureOut)
                      .on('featureClick', featureClick);
              });
      });
    </script>
    <!--<script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-40224528-2', 'lanacion.com.ar');
      ga('send', 'pageview');
    </script>-->
  </body>
</html>
